name: BBS Automation

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  
  workflow_dispatch:  # Allow manual trigger
  
  discussion:
    types: [created, edited]

permissions:
  contents: write
  discussions: write
  issues: write

jobs:
  update-bbs:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: ðŸ“¦ Install dependencies
        run: |
          pip install requests PyGithub feedgen
      
      - name: ðŸ¤– Run BBS Bot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ github.event.repository.name }}
        run: |
          python bbs-bot.py
      
      - name: ðŸ“¤ Commit and push changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "BBS Bot"
          
          git add -A
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ¤– Auto-update BBS board [$(date +'%Y-%m-%d %H:%M UTC')]"
            git push
          fi

  welcome-new-discussion:
    runs-on: ubuntu-latest
    if: github.event_name == 'discussion' && github.event.action == 'created'
    
    steps:
      - name: ðŸ‘‹ Send welcome message
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const discussionNumber = context.payload.discussion.number;
            const author = context.payload.discussion.user.login;
            const discussionNodeId = context.payload.discussion.node_id;
            
            const welcomeMessage = `
            ðŸ‘‹ **Welcome to Hackteam-Red BBS, @${author}!**
            
            Thank you for your post! Here's what happens next:
            
            - ðŸ·ï¸ Your post will be automatically categorized
            - ðŸ“Š It will appear in our bulletin board within 6 hours
            - ðŸ”” Community members will be notified
            - ðŸ“¡ Your post is added to our RSS feed
            
            ## Quick Tips:
            
            - Use clear, descriptive titles
            - Add relevant labels for better visibility
            - Check back for responses and updates
            - Mark as "Answered" when resolved
            
            ## Categories:
            
            - ðŸ’¼ **Jobs & Opportunities** - Hiring, positions, gigs
            - ðŸ¤ **Help Wanted** - Need assistance or expertise
            - ðŸ”§ **Tools & Resources** - Scripts, tools, utilities
            - ðŸ“š **Learning** - Tutorials, courses, knowledge sharing
            - ðŸŽ¯ **Projects** - Collaboration opportunities
            - ðŸ“¢ **Announcements** - General news and updates
            
            ---
            
            ðŸš€ **Join our community:**
            - Star our repos to stay updated
            - Follow discussions you're interested in
            - Share your knowledge and help others
            
            *This is an automated message from BBS Bot* ðŸ¤–
            `;
            
            // Use GraphQL API for discussions
            const mutation = `
              mutation($discussionId: ID!, $body: String!) {
                addDiscussionComment(input: {discussionId: $discussionId, body: $body}) {
                  comment {
                    id
                  }
                }
              }
            `;
            
            try {
              await github.graphql(mutation, {
                discussionId: discussionNodeId,
                body: welcomeMessage
              });
              console.log('Welcome message sent successfully!');
            } catch (error) {
              console.error('Error sending welcome message:', error);
            }

  auto-label:
    runs-on: ubuntu-latest
    if: github.event_name == 'discussion' && github.event.action == 'created'
    
    steps:
      - name: ðŸ·ï¸ Auto-label discussion
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = context.payload.discussion.title.toLowerCase();
            const body = (context.payload.discussion.body || '').toLowerCase();
            const content = title + ' ' + body;
            
            const labelRules = {
              'job': ['hiring', 'job', 'vacancy', 'position', 'career', 'work', 'employment'],
              'help-wanted': ['help', 'need', 'looking for', 'assistance', 'support', 'question'],
              'collaboration': ['collab', 'partner', 'team up', 'join', 'together', 'contribute'],
              'tools': ['tool', 'script', 'software', 'resource', 'utility', 'exploit'],
              'learning': ['learn', 'tutorial', 'course', 'training', 'education', 'guide'],
              'urgent': ['urgent', 'asap', 'immediately', 'critical', 'emergency'],
              'red-team': ['red team', 'redteam', 'pentest', 'penetration', 'offensive'],
              'blue-team': ['blue team', 'blueteam', 'defense', 'defensive', 'soc'],
              'research': ['research', 'analysis', 'study', 'investigation', 'cve']
            };
            
            const detectedLabels = [];
            
            for (const [label, keywords] of Object.entries(labelRules)) {
              if (keywords.some(keyword => content.includes(keyword))) {
                detectedLabels.push(label);
              }
            }
            
            if (detectedLabels.length > 0) {
              console.log(`Detected labels: ${detectedLabels.join(', ')}`);
              
              // Get repository labels
              const repoLabels = await github.rest.issues.listLabelsForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100
              });
              
              const existingLabelNames = repoLabels.data.map(l => l.name);
              
              // Create labels if they don't exist
              for (const labelName of detectedLabels) {
                if (!existingLabelNames.includes(labelName)) {
                  console.log(`Creating label: ${labelName}`);
                  try {
                    await github.rest.issues.createLabel({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      name: labelName,
                      color: Math.floor(Math.random()*16777215).toString(16)
                    });
                  } catch (error) {
                    console.error(`Error creating label ${labelName}:`, error.message);
                  }
                }
              }
              
              console.log(`Auto-labeling detected: ${detectedLabels.join(', ')}`);
              core.info(`Suggested labels for this discussion: ${detectedLabels.join(', ')}`);
            } else {
              console.log('No matching labels found');
            }

  generate-stats:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
      
      - name: ðŸ“Š Generate statistics
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            
            // Use GraphQL to fetch discussions
            const query = `
              query($owner: String!, $repo: String!, $cursor: String) {
                repository(owner: $owner, name: $repo) {
                  discussions(first: 100, after: $cursor) {
                    pageInfo {
                      hasNextPage
                      endCursor
                    }
                    nodes {
                      title
                      body
                      createdAt
                      updatedAt
                      author {
                        login
                      }
                      category {
                        name
                      }
                      comments {
                        totalCount
                      }
                    }
                  }
                }
              }
            `;
            
            let allDiscussions = [];
            let hasNextPage = true;
            let cursor = null;
            
            while (hasNextPage) {
              const result = await github.graphql(query, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                cursor: cursor
              });
              
              const discussions = result.repository.discussions;
              allDiscussions = allDiscussions.concat(discussions.nodes);
              
              hasNextPage = discussions.pageInfo.hasNextPage;
              cursor = discussions.pageInfo.endCursor;
            }
            
            console.log(`Fetched ${allDiscussions.length} discussions`);
            
            // Calculate statistics
            const stats = {
              total: allDiscussions.length,
              lastWeek: 0,
              categories: {},
              topContributors: {},
              generatedAt: new Date().toISOString()
            };
            
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            
            allDiscussions.forEach(disc => {
              // Recent activity
              if (new Date(disc.createdAt) > oneWeekAgo) {
                stats.lastWeek++;
              }
              
              // Categories
              const category = disc.category?.name || 'Uncategorized';
              stats.categories[category] = (stats.categories[category] || 0) + 1;
              
              // Contributors
              const author = disc.author?.login || 'Unknown';
              stats.topContributors[author] = (stats.topContributors[author] || 0) + 1;
            });
            
            // Sort top contributors
            stats.topContributors = Object.entries(stats.topContributors)
              .sort((a, b) => b[1] - a[1])
              .slice(0, 10)
              .reduce((obj, [key, value]) => ({ ...obj, [key]: value }), {});
            
            // Save statistics
            fs.writeFileSync('stats.json', JSON.stringify(stats, null, 2));
            
            console.log('Statistics generated:');
            console.log(JSON.stringify(stats, null, 2));
      
      - name: ðŸ“¤ Commit statistics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "BBS Bot"
          
          git add stats.json
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "ðŸ“Š Update statistics [$(date +'%Y-%m-%d')]"
            git push
          fi
